<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Mushtaq Ahmed]]></title>
  <link href="http://mushtaq.github.io/atom.xml" rel="self"/>
  <link href="http://mushtaq.github.io/"/>
  <updated>2013-12-07T17:21:26+05:30</updated>
  <id>http://mushtaq.github.io/</id>
  <author>
    <name><![CDATA[Your Name]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Synchronizing Scala Futures: Comparing Styles]]></title>
    <link href="http://mushtaq.github.io/blog/2013/03/09/synchronizing-scala-futures-comparing-styles/"/>
    <updated>2013-03-09T16:02:00+05:30</updated>
    <id>http://mushtaq.github.io/blog/2013/03/09/synchronizing-scala-futures-comparing-styles</id>
    <content type="html"><![CDATA[<p>You deal with <a href="http://docs.scala-lang.org/overviews/core/futures.html">futures</a> all the time if you are using <a href="http://www.playframework.com/">play framework</a>. For example, call to external webservices or mongodb via <a href="http://reactivemongo.org/">reactivemongo</a> driver returns future. Consider the signatures of two apis from repository classes wrapping mongodb access:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">productRepo</span><span class="o">.</span><span class="n">getProduct</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Product</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">metadataRepo</span><span class="o">.</span><span class="n">getProductMetadata</span><span class="o">(</span><span class="n">productId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will have to use the result of the first call to obtain the productId required for the second call. But the return type for both the calls are futures, so how to use the product value inside a future without blocking it. Well, using higher order function flatMap defined on futures, you can do something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">metadata</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">productRepo</span><span class="o">.</span><span class="n">getProduct</span><span class="o">(</span><span class="s">&quot;watch&quot;</span><span class="o">).</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">product</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">metadataRepo</span><span class="o">.</span><span class="n">getProductMetadata</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a lot of other useful combinators defined for futures like map, filter, recover etc. Here, flatMap ensure that call to getProductMetadata will not happen unless future returned by getProduct is successful. An important insight is that composing futures using combinators like flatMap is essentially synchronizing futures without blocking.</p>

<p>We know that flatMap operations can also be represented as for comprehension. Like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">metadata</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">product</span> <span class="k">&lt;-</span> <span class="n">productRepo</span><span class="o">.</span><span class="n">getProduct</span><span class="o">(</span><span class="s">&quot;watch&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">metadata</span> <span class="k">&lt;-</span> <span class="n">metadataRepo</span><span class="o">.</span><span class="n">getProductMetadata</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="n">metadata</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unlike flatMap invloves for does not do invert the program flow. Hence, in general code using for is more readable than directly using flatMap. This may not be the case always. For example if we want to throw exception if product is not available in the store, for approach is more complicated compared to flatMap:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">metadata</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">product</span> <span class="k">&lt;-</span> <span class="n">productRepo</span><span class="o">.</span><span class="n">getProduct</span><span class="o">(</span><span class="s">&quot;watch&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">metadata</span> <span class="k">&lt;-</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">isNotAvailable</span><span class="o">)</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nc">ProductNotAvailableException</span><span class="o">(</span><span class="s">&quot;product not found&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">metadataRepo</span><span class="o">.</span><span class="n">getProductMetadata</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="n">metadata</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is an alternate way to synchronize futures using continuations also known as dataflow style. We will have to use <a href="http://doc.akka.io/docs/akka/2.1.0/scala/dataflow.html">akka&rsquo;s dataflow library</a> which provides a flow block inside which call to apply() on futures returns the contained element (it does not actually return but it does look like that). This style is somewhat similar to for comprehensions but allows mixing imperative code with dataflow style very easy. The above program then can be written as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">metadata</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Metadata</span><span class="o">]</span> <span class="k">=</span> <span class="n">flow</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">product</span> <span class="k">=</span> <span class="n">productRepo</span><span class="o">.</span><span class="n">getProduct</span><span class="o">(</span><span class="s">&quot;watch&quot;</span><span class="o">)()</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">isNotAvailable</span><span class="o">)</span>
</span><span class='line'>      <span class="k">throw</span> <span class="k">new</span> <span class="nc">ProductNotAvailableException</span><span class="o">(</span><span class="s">&quot;product not found&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="n">metadataRepo</span><span class="o">.</span><span class="n">getProductMetadata</span><span class="o">(</span><span class="n">product</span><span class="o">.</span><span class="n">id</span><span class="o">)()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We have been using dataflow style with futures a lot in our project and it has worked very well so far. Continuations bring in their own constraints on the structure of your code. Compiler generated error messages when you violate those constraints are intimidating. We will discuss how to deal with them in a future post.</p>
]]></content>
  </entry>
  
</feed>
